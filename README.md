# DyakonovAlex_infra
DyakonovAlex Infra repository

## Homework 11

### План
- Локальная разработка при помощи Vargant, доработка ролей для провиженга в Vargant
- Тестирование ролей при помощи Molecule и Testinfra
- Переключение сбора образов пакером на использование ролей
- Подключение Travis CI для автоматического прогона тестов


## Homework 10

### Самостоятельное задание

- Созданы роли app и db  
- Проведён деплой с использованием созданных ролей  
- Вынесены переменные в group_vars  
- Плейбуки перенесены в playbooks  
- Исправлены шаблоны packer  
- В директорию old перенесено все что не относится к текущей конфигурации
- Созданы окружения stage и prod
- Проведён деплой окружениий stage и prod
- В окружения добавлены requirements.yml установлена роль jdauphant.nginx  
- Добавлено открытие 80 порта для инстанса приложения в конфигурацию Terraform  
- Добавлен вызов роли jdauphant.nginx в плейбук app.yml  
- Применен плейбук site.yml для окружения stage и проверено, что приложение теперь доступно на 80 порту  

### Работа с Ansible Vault

- Создан ~/.ansible/vault.key  
- Добавлена опция vault_password_file в ansible.cfg  
- Добавлен плейбук для создания пользователей  
- Добавлен файл с данными пользователей для каждого окружения credentials.yml  
- Зашифрованы файлы с данными пользователей используя vault_otus.key  
- Проверено содержимое файлов, файлы зашифрованы  
- Добавлен вызов плейбука в файл site.yml и выполнен для окружения stage
- Проверено создание пользователей


## Homework 9

### Один playbook, один сценарий  
- Добавлен reddit_app.yml  
- Добавлены шаблоны  
- Добавлены handlers  
- Добавлены таски для конфигурирования приложения, базы и деплоя
- Проведён деплой

### Один плейбук, несколько сценариев  
- Добавлен reddit_app2.yml с разбивкой по сценариям
- Проведён деплой

### Несколько плейбуков
- Добавлены отдельные playbooks для разных хостов  
- Добавлен site.yml объединяющий запуск playbooks
- Проведён деплой

### Провижининг в Packer  
- Добавлены packer_app.yml и packer_db.yml  
- Выполнен билд образов с использованием ansible
- На основе созданных app и db образов запущено stage окружение  
- Проверено, что c помощью плейбука site.yml окружение конфигурируется, а приложение деплоится и работает 

## Homework 8

- Установлен ansible
- Добавлен inventory 
- Добавлен ansible.cfg
- Добавлен inventory.yml
- Убедился что ansible может управлять группой хостов
- Проверил выполнение команд
- Добавлен простой плейбук clone.yml

При первом запуске 
ansible-playbook clone.yml 
репозиторий уже был клонирован в директорию ~/reddit и изменений не произошло. changed=0

После выполнения команды 
ansible app -m command -a 'rm -rf ~/reddit' 
удалилась директория 
При втором запуске ansible-playbook clone.yml репозиторий клонировался. changed=1

- Ознакомился с документацией на формат JSON 
- Добавлен inventory.json
- Добавлено ansible.cfg (Подозреваю, что надо было делать с помощью скрипта на python, поэтому задание со * пока не сделано.)

## Homework 7  

- Добавлено правило файрволла для ssh  
- Добавлен IP для инстанса с приложением  
- Добавлены шаблоны packer для VM: db.json и app.json  
- Добавлены шаблоны terraform для развёртывания VM: db.tf и app.tf  
- Добавлены модули terraform на основе шаблонов db.tf, app.tf и vpc.tf
- Добавлен модуль SweetOps/storage-bucket/google
- Создан бакет

### Самостоятельные задание 1  

1. Проверил работу параметризованного модуля vpc. Ввёл в source_ranges чужой IP адрес, применил правило и проверил отсутствие соединения к обоим хостам по ssh. Проконтролировал, как изменилось правило файрвола в веб консоли.
2. Ввёл в source_ranges свой IP адрес, применил правило и проверил наличие соединения к обоим хостам по ssh.
3. Вернул 0.0.0.0/0 в source_ranges.

### Самостоятельные задания 2  

1. Удалил из папки terraform файлы main.tf, outputs.tf, terraform.tfvars, variables.tf, так как они теперь перенесены в stage и prod
2. Параметризировал конфигурацию модулей насколько считаю нужным:  
   Добавил настройки имён инстансов через переменные.  
3. Отформатировал конфигурационные файлы, используя команду terraform fmt

### Задание со * 1  

1. Настроил хранение стейт файла в удаленном бекенде (remote backends) для окружений stage и prod, используя Google Cloud Storage в качестве бекенда. Описание бекенда вынес в отдельный файл backend.tf 
2. Перенёс конфигурационные файлы Terraform в другую директорию (вне репозитория). Проверил, что state-файл (terraform.tfstate) отсутствует. Запустил Terraform в обеих директориях и проконтролировал, что он "видит" текущее состояние независимо от директории, в которой запускается  
3. Попробовал запустить применение конфигурации одновременно, чтобы проверить работу блокировок  

### Задание с ** 2  

1. Добавил необходимые provisioner в модули для деплоя и работы приложения и бд. Файлы, используемые в provisioner, расположены в директории модулей 



## Homework 6  
- установлен terraform
- создан инстанс с помощью terraform
- добавлен ssh-ключ
- добавлен тег файрволла
- добавлен скрипт деплоя
- переразвёрнут инстанс с деплоем приложения
- добавлены входные переменные
- переменные определены в terraform.tfvars
- удалён и создан инстанс

### Самостоятельные задания  

- Определена input переменная для приватного ключа 
- Определена input переменная для задания зоны 
- Отформатированы все конфигурационные файлы через terraform fmt  
- Добавлен файл terraform.tfvars.example в котором указаны переменные для образца


## Homework 5
параметризированы:  
- ID проекта (обязательно)  
- source_image_family (обязательно)  
- machine_type  
- описание образа  
- размер и тип диска  
- название сети  
- тег сети  

Создан базовый образ семейства reddit-base

## Homework 4
<details>
testapp_IP = 35.187.112.233
testapp_port = 9292
</details>

## Homework 3
<details>
bastion_IP = 35.187.112.233
someinternalhost_IP = 10.132.0.3

### One line connection to someinternalhost
ssh -o ProxyCommand='ssh -i ~/.ssh/appuser -W %h:%p appuser@35.187.112.233' appuser@10.132.0.3

### Connection to someinternalhost by alias

create file ~/.ssh/config

add to ~/.ssh/config:

HOST bastion
  user appuser
  IdentityFile ~/.ssh/appuser
  hostname 35.187.112.233


HOST someinternalhost
  user appuser
  IdentityFile ~/.ssh/appuser
  hostname 10.132.0.3
  ProxyCommand ssh bastion -W %h:%p
</details>
